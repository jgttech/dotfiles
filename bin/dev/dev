#!/usr/bin/env bash
set -euo pipefail

service="dev"
state="$(docker compose ps --format=json ${service} | jq ".State" | tr -d '\"')"

# Ensure the dev container is running
if [[ "$state" != "running" ]]; then
  docker compose up ${service} -d
fi

# Sync code using tar streaming (highly performant, no intermediate files)
tar -c --exclude-from=.dockerignore -C . . | \
  docker compose exec -T dev bash -c '
    rm -rf /home/user/.dotfiles/* /home/user/.dotfiles/.[!.]* 2>/dev/null || true
    mkdir -p /home/user/.dotfiles
    cd /home/user/.dotfiles
    tar -x
  '

# Run the CLI with all passed arguments
docker compose exec ${service} bash -c "cd ${PROJECT_DOCKER_HOME} && go run main.go \"\$@\"" -- "$@"
