#!/usr/bin/env bash
set -euo pipefail

# Branch to checkout
branch="v3"

# The current platform the user is running on.
# This is used by some of the install utility
# functions.
current_platform=$(uname -s | tr '[:upper:]' '[:lower:]')

# This is the custom font that is installed
# when stow links the packages into the system.
font_family="MesloLGS NF"

# The location to install the repo to. The
# location is resolve relative to the users
# $HOME environment variable. So everything
# must be relative to that context.
home=".dotfiles"

# The repo to clone when installing dotfiles.
repo="https://github.com/jgttech/dotfiles.git"

# If dependencies are missing, the user needs
# to lookup their platforms approach to install
# the missing dependencies. The one things this
# install script does not handle is installing
# dependencies. It just checks for them. This is
# because maintianing install methods are various
# Linux and MacOS distro's and/or versions is a
# LOT of work and not what these tools are for.
dependencies=( \
  "direnv" \
  "aqua" \
  "just" \
  "omz" \
)

# Tracks what is missing to, if something is
# missing, I can display the full list of what
# is missing instead of failing on each missing
# system package.
missing=()

# This function uses a ZSH sub-process to check it a
# binary/package exists on the system. This is required
# because the configuration uses ZSH as the default shell.
# If something it checked against the BASH shell (that
# runs this install) then I can't properly detect what
# the ZSH environment detects and can't guarentee compatibility.
# So checking against ZSH is a requirement.
installed() { zsh -i -c "which $1" &> /dev/null ; }

function install_zsh_plugin {
  local repo="$1"
  local dir="$2"

  if [[ ! -d "$dir" ]]; then
    git clone "$repo" "$dir"
  fi
}

# Check if the platform matches whatever platform we are
# looking for. This is done to allow platform specifc
# commands to be run for things like reloading system fonts
# and other platform specific needs.
function is_platform {
  local desired_platform="$1"

  # Check if current platform contains the
  # supported_platform platform string or if supported_platform
  # platform contains the current platform string
  if \
    [[ "$current_platform" == *"$desired_platform"* ]] || \
    [[ "$desired_platform" == *"$current_platform"* ]]; \
  then
    return 0
  fi

  return 1
}

# Unfortunately, I need to make sure that ZSH is
# installed before continuing the installation
# of the dotfiles because it is used to validate
# the existence of packages on the system.
if ! command -v "zsh" &> /dev/null; then
  echo "[NOTE]"
  echo "This install script uses ZSH to validate"
  echo "the exsitence of packages your system"
  echo "needs in order to function with these"
  echo "dotfiles."
  echo ""
  echo "[ERROR]"
  echo "ZSH required to install dotfiles. Please,"
  echo "Please install ZSH and re-run the script."
  exit 1
fi

# Check which script dependencies are needed.
for dep in "${dependencies[@]}"; do
  # For whatever reason the "fc-cache",
  # "fc-list", etc, all come from the "fontconfig"
  # package. So when we are checking for that
  # package we just need to make sure that one of
  # the commands that becomes available exists to
  # validate that "fontconfig" was installed.
  if [[ "$dep" == "fontconfig" ]]; then
    if ! installed "fc-list"; then
      missing+=("$dep")
    fi
  # Outside "fontconfig" we cna use the typical
  # approach of checking each package as usual.
  else
    if ! installed "$dep"; then
      missing+=("$dep")
    fi
  fi
done

# If we have missing packages, fail the install
# and display all the missing packages.
if [[ ${#missing[@]} -ne 0 ]]; then
  echo "[ERROR]"
  echo "Missing (${#missing[@]}) required dependencies:"

  for missing in "${missing[@]}"; do
    echo " $missing"
  done

  exit 1
fi

if ! installed "p10k"; then
  git clone --depth=1 \
    https://github.com/romkatv/powerlevel10k.git \
    "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"
fi

install_zsh_plugin \
  https://github.com/zsh-users/zsh-autosuggestions \
  "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-autosuggestions"

install_zsh_plugin \
  https://github.com/zsh-users/zsh-syntax-highlighting.git \
  "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting"

# The paths we need to build the commands used
# to install the dotfiles.
home_dir="$HOME/$home"

# Reload font cache to load custom user
# fonts into the system. We want to this
# even if the user does have an error because
# it is possible that the fonts either did not
# get installed or something else unexpected has
# happened and this would, technically, reload
# the system fonts so that if/when we check we
# can be sure the latest version of the fonts
# in the system are what we are looking at.
if is_platform "linux"; then
  fc-cache -f
  cnt=$(fc-list | grep -c "$font_family" || true)

  # During dependency checking, we verify that "fontconfig"
  # is installed, so this should work, as expected.
  if [[ "${cnt}" -le 0 ]]; then
    echo "[WARNING]"
    echo "Failed to load fonts for '$font_family'"
  fi
elif is_platform "darwin"; then
  atsutil databases –removeUser
  atsutil server –shutdown
  atsutil server –ping
fi

if [[ $? -ne 0 ]]; then
  echo "[ERROR]"
  echo "Status Code: $?"
  echo "Unexpected error occured, cleaning up..."

  if [[ -d "$home_dir" ]]; then
    rm -rf "$home_dir"
  fi

  exit 0
else
  wd="$(pwd)"
  dev="${DOTFILES_DEV:-false}"

  if [[ "$dev" == "true" ]]; then
    cp -rv /tmp/dotfiles "$home_dir"
  else
    git clone https://github.com/jgttech/dotfiles.git "$home_dir"
  fi

  cd "$home_dir"
  git checkout "$branch"

  [[ ! -f ".envrc" ]] && {
    echo "ERROR: Missing .envrc file."
    exit 1
  }

  source .envrc
  export PATH="$HOME/$home/.bin:$PATH"

  just install prod
  # just build
  # dotfiles install

  cd "$wd"
  echo "Done"
fi
