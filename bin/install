#!/usr/bin/env bash
set -euo pipefail

# Configuration
REPO="jgttech/dotfiles"  # Change to your GitHub repo (owner/repo)
BINARY_NAME="dotfiles"
INSTALL_DIR="${HOME}/.local/bin"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

detect_os() {
  case "$(uname -s)" in
    Linux*)   echo "linux" ;;
    Darwin*)  echo "darwin" ;;
    *)
      echo -e "${RED}Error: Unsupported operating system$(NC)" >&2
      exit 1
      ;;
  esac
}

detect_arch() {
  local arch
  arch="$(uname -m)"

  case "$arch" in
    x86_64)  echo "amd64" ;;
    aarch64) echo "arm64" ;;
    arm64)   echo "arm64" ;;
    armv7l)  echo "arm-v7" ;;
    *)
      echo -e "${RED}Error: Unsupported architecture: $arch${NC}" >&2
      exit 1
      ;;
  esac
}

get_latest_version() {
  curl -s "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/'
}

install_binary() {
  local version="${1:-latest}"
  local os
  local arch
  local binary_filename
  local download_url

  os=$(detect_os)
  arch=$(detect_arch)
  binary_filename="${BINARY_NAME}-${os}-${arch}"

  echo -e "${YELLOW}Detecting platform...${NC}"
  echo "  OS: $os"
  echo "  Architecture: $arch"
  echo "  Binary: $binary_filename"
  echo ""

  # Get version
  if [ "$version" = "latest" ]; then
    echo -e "${YELLOW}Fetching latest release...${NC}"
    version=$(get_latest_version)

    if [ -z "$version" ]; then
      echo -e "${RED}Error: Could not determine latest version${NC}" >&2
      exit 1
    fi
  fi

  echo "  Version: $version"
  echo ""

  # Construct download URL
  download_url="https://github.com/${REPO}/releases/download/${version}/${binary_filename}"

  echo -e "${YELLOW}Downloading binary...${NC}"
  echo "  From: $download_url"

  # Create install directory if it doesn't exist
  mkdir -p "$INSTALL_DIR"

  # Download binary
  if ! curl -fsSL "$download_url" -o "${INSTALL_DIR}/${BINARY_NAME}"; then
    echo -e "${RED}Error: Failed to download binary${NC}" >&2
    echo "  URL: $download_url" >&2
    exit 1
  fi

  # Make executable
  chmod +x "${INSTALL_DIR}/${BINARY_NAME}"

  echo -e "${GREEN}✓ Successfully installed ${BINARY_NAME} ${version}${NC}"
  echo "  Location: ${INSTALL_DIR}/${BINARY_NAME}"
  echo ""

  # Check if install directory is in PATH
  if [[ ":$PATH:" != *":${INSTALL_DIR}:"* ]]; then
    echo -e "${YELLOW}Warning: ${INSTALL_DIR} is not in your PATH${NC}"
    echo "Add the following to your shell config (~/.bashrc, ~/.zshrc, etc.):"
    echo "  export PATH=\"${INSTALL_DIR}:\$PATH\""
    echo ""
  fi

  # Verify installation
  if command -v "${BINARY_NAME}" &> /dev/null; then
    echo -e "${GREEN}✓ ${BINARY_NAME} is ready to use!${NC}"
    "${BINARY_NAME}" --version || true
  else
    echo -e "${YELLOW}Run 'export PATH=\"${INSTALL_DIR}:\$PATH\"' to use ${BINARY_NAME}${NC}"
  fi
}

# Main
main() {
  local version="${1:-latest}"

  echo -e "${GREEN}Installing ${BINARY_NAME}...${NC}"
  echo ""

  install_binary "$version"
}

main "$@"
