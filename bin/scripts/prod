#!/usr/bin/env bash
set -euo pipefail

service="prod"
image="dotfiles-prod"

echo "Removing existing prod containers if any exist..."
containers=$(docker compose ps -aq ${service} 2>/dev/null)
if [ -n "$containers" ]; then
  docker rm -f $containers
fi

# Check if prod image exists, build if not
if [[ -z "$(docker images -q ${image})" ]]; then
  echo "Prod image not found. Building..."
  docker compose build ${service}
else
  echo "Using existing prod image."
fi

echo "Creating new prod container..."
docker compose run -d ${service}

echo "Executing install script..."
docker compose exec -T ${service} bash < bin/install || true

# If arguments were provided, execute the dotfiles command
if [ $# -gt 0 ]; then
  echo "Running: dotfiles $@"
  docker compose exec -T ${service} bash -c "export PATH=\"/home/user/.local/bin:\$PATH\" && dotfiles $*"
fi

echo "Done! Container is still running for debugging."
echo "To inspect: docker compose exec ${service} bash"
echo "To remove: docker compose rm -sf ${service}"
